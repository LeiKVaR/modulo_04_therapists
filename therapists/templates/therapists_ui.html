<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Gesti√≥n de Terapeutas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../static/css/estilos.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- npm para personalizar las alertas-->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- npm para mejorar las peticiones de frontend al backend-->
</head>
<!-- Escructura general del sistema-->

<body>
  <!-- Campos para registro de terapeutas -->
  <h1>Registrar Terapeuta</h1>
  <form id="therapist-form" enctype="multipart/form-data">
    <div>
      <label>Tipo de Documento:</label>
      <select name="document_type" required>
        <option value="">Seleccione</option>
        <option value="DNI">DNI</option>
        <option value="Carnet de Extranjeria">Carn√© de Extranjer√≠a</option>
        <option value="Pasaporte">Pasaporte</option>
        <option value="Carne de Refugiado">Carn√© de Refugiado</option>
        <option value="PTP">PTP</option>
      </select>
    </div>
    <div>
      <label>Nro Documento:</label>
      <input type="text" name="document_number" required maxlength="20" />
    </div>
    <div>
      <label>Apellido Paterno:</label>
      <input type="text" name="last_name_paternal" required />
    </div>
    <div>
      <label>Apellido Materno:</label>
      <input type="text" name="last_name_maternal" />
    </div>
    <div>
      <label>Nombres:</label>
      <input type="text" name="first_name" required />
    </div>
    <div>
      <label>Fecha de Nacimiento:</label>
      <input type="date" name="birth_date" required />
    </div>
    <div>
      <label>Sexo:</label>
      <select name="gender" required>
        <option value="">Seleccione</option>
        <option value="Masculino">Masculino</option>
        <option value="Femenino">Femenino</option>
        <option value="Otro">Otro</option>
      </select>
    </div>
    <div>
      <label>Tel√©fono:</label>
      <input type="text" name="phone" required maxlength="15" />
    </div>
    <div>
      <label>Email:</label>
      <input type="email" name="email" required />
    </div>
    <!-- Ubicaci√≥n -->
    <div>
      <label>Departamento:</label>
      <select name="department" id="department" required>
        <option value="">Seleccione</option>
      </select>
    </div>
    <div>
      <label>Provincia:</label>
      <select name="province" id="province" required>
        <option value="">Seleccione</option>
      </select>
    </div>
    <div>
      <label>Distrito</label>
      <select name="district" id="district" required>
        <option value="">Seleccione</option>
      </select>
    </div>

    <div class="full-width">
      <label>Direcci√≥n:</label>
      <textarea name="address" required></textarea>
    </div>
    <div class="full-width">
      <label>Referencia Personal:</label>
      <input type="text" name="personal_reference" />
    </div>
    <div>
      <label>Activo:</label>
      <input type="checkbox" name="is_active" checked />
    </div>
    <div>
      <label>Foto de Perfil:</label>
      <input type="file" name="profile_picture" accept="image/*" />
    </div>
    <div class="full-width">
      <button type="submit">Registrar</button>
    </div>
  </form>
  <!-- filtros terapeutas-->
  <h2>Buscar Terapeutas</h2>
  <div class="filters">
    <input type="text" id="searchQuery" placeholder="Buscar por nombre, apellidos, documento, email..." />
  </div>
  <!-- boton de restaurar-->
  <button id="btnRestaurar" style="
          padding: 6px 12px;
          font-size: 14px;
          border-radius: 5px;
          background: #43b36a;
          color: #fff;
          border: none;
          margin-left: 10px;
        ">
    Restaurar
  </button>
  </div>

  <!-- Modal de restauraci√≥n -->
  <div id="restoreModal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        z-index: 1001;
        align-items: center;
        justify-content: center;
      ">
    <div style="
          background: white;
          padding: 30px;
          border-radius: 10px;
          min-width: 350px;
          max-width: 95vw;
          position: relative;
        ">
      <!-- Tabla con los terapeutas eliminados -->
      <h2>Restaurar Terapeutas</h2>
      <table style="width: 100%; margin-bottom: 20px" id="restoreTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>DNI</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="text-align: right">
        <button onclick="cerrarRestoreModal()" style="
              background: #43b36a;
              color: #fff;
              padding: 8px 20px;
              border: none;
              border-radius: 5px;
            ">
          Cerrar
        </button>
      </div>
      <button onclick="cerrarRestoreModal()" style="
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #222;
            font-size: 22px;
            cursor: pointer;
          ">
        √ó
      </button>
    </div>
  </div>
  <!-- Tabla de terapeutas activos -->
  <table id="therapist-table">
    <thead>
      <tr>
        <th>Documento</th>
        <th>Nombre</th>
        <th>Fecha Nac.</th>
        <th>Sexo</th>
        <th>Email</th>
        <th>Tel√©fono</th>
        <th>Ubicaci√≥n</th>
        <th>Activo</th>
        <th>Foto</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <!-- Modal de editar -->
  <div id="editModal">
    <div class="card">
      <h2>Editar Terapeuta</h2>
      <form id="editForm" enctype="multipart/form-data">
        <input type="hidden" name="id" />
        <div>
          <label>Tipo de Documento:</label>
          <select name="document_type" required>
            <option value="">Seleccione</option>
            <option value="DNI">DNI</option>
            <option value="Carnet de Extranjeria">
              Carn√© de Extranjer√≠a
            </option>
            <option value="Pasaporte">Pasaporte</option>
            <option value="Carne de Refugiado">Carn√© de Refugiado</option>
            <option value="PTP">PTP</option>
          </select>
        </div>
        <div>
          <label>Nro Documento:</label>
          <input type="text" name="document_number" required maxlength="20" />
        </div>
        <div>
          <label>Apellido Paterno:</label>
          <input type="text" name="last_name_paternal" />
        </div>
        <div>
          <label>Apellido Materno:</label>
          <input type="text" name="last_name_maternal" />
        </div>
        <div>
          <label>Nombres:</label>
          <input type="text" name="first_name" required />
        </div>
        <div>
          <label>Fecha de Nacimiento:</label>
          <input type="date" name="birth_date" required />
        </div>
        <div>
          <label>Sexo:</label>
          <select name="gender" required>
            <option value="">Seleccione</option>
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div>
          <label>Tel√©fono:</label>
          <input type="text" name="phone" required maxlength="15" />
        </div>
        <div>
          <label>Email:</label>
          <input type="email" name="email" required />
        </div>
        <div>
          <label>Departamento:</label>
          <select name="department" id="edit_department" required>
            <option value="">Seleccione</option>
          </select>
        </div>
        <div>
          <label>Provincia:</label>
          <select name="province" id="edit_province" required>
            <option value="">Seleccione</option>
          </select>
        </div>
        <div>
          <label>Distrito:</label>
          <select name="district" id="edit_district" required>
            <option value="">Seleccione</option>
          </select>
        </div>
        <div>
          <label>Direcci√≥n:</label>
          <textarea name="address" required></textarea>
        </div>
        <div>
          <label>Referencia Personal:</label>
          <input type="text" name="personal_reference" />
        </div>
        <div>
          <label>Activo:</label>
          <input type="checkbox" name="is_active" />
        </div>
        <div>
          <label>Foto de Perfil:</label>
          <input type="file" name="profile_picture" accept="image/*" />
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px">
          <button type="button" onclick="closeEditModal()">Cancelar</button>
          <button type="submit">Actualizar</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Modal de mas informacion del terapeuta -->
  <div id="infoModal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      ">
    <div style="
          background: #222;
          color: #fff;
          padding: 30px;
          border-radius: 15px;
          min-width: 350px;
          max-width: 95vw;
          position: relative;
        ">
      <h2 style="text-align: center; margin-bottom: 10px">
        Informaci√≥n del Terapeuta
      </h2>
      <div id="infoContent"></div>
      <div style="margin-top: 20px; text-align: right">
        <button onclick="cerrarInfoModal()" style="
              background: #43b36a;
              color: #fff;
              padding: 8px 20px;
              border: none;
              border-radius: 5px;
            ">
          Cerrar
        </button>
      </div>
      <button onclick="cerrarInfoModal()" style="
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
          ">
        √ó
      </button>
    </div>
  </div>

  <script>

    // 1. Configuraci√≥n de Axios y CSRF
    // Lee la cookie de CSRF y la a√±ade a las peticiones POST/PUT/DELETE para cumplir con la seguridad de Django.

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Asegura env√≠o de cookies + CSRF para m√©todos no seguros

    axios.defaults.withCredentials = true;
    axios.defaults.xsrfCookieName = 'csrftoken';
    axios.defaults.xsrfHeaderName = 'X-CSRFToken';

    axios.interceptors.request.use((config) => {
      const needsCsrf = /^(post|put|patch|delete)$/i.test(config.method || '');
      if (needsCsrf && !config.headers['X-CSRFToken']) {
        const token = getCookie('csrftoken');
        if (token) config.headers['X-CSRFToken'] = token;
      }
      return config;
    });

    // 2. Funci√≥n para mostrar errores de Axios de forma amigable usando SweetAlert2.

    function showAxiosError(error, fallback = 'Ocurri√≥ un error') {
      const detail =
        error?.response?.data?.detail ||
        error?.response?.data?.error ||
        error?.response?.statusText ||
        error?.message ||
        fallback;
      Swal.fire({ icon: 'error', title: 'Error', text: String(detail) });
    }

    // 3. Variables globales y constantes para la API y formularios.

    const apiUrl = 'http://127.0.0.1:8000/therapists/';
    const form = document.getElementById('therapist-form');
    const tableBody = document.querySelector('#therapist-table tbody');
    const searchInput = document.querySelector('#searchQuery');
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    let editingRow = null;
    let currentCancelToken = null;

    // 4. Validaciones de documento seg√∫n tipo (DNI, Pasaporte, etc.)

    const DOC_MAX = {
      DNI: 9,
      'Carnet de Extranjeria': 12,
      Pasaporte: 9,
      'Carne de Refugiado': 10,
      PTP: 9,
    };
    const DOC_LENGTHS = {
      DNI: [8, 9],
      'Carnet de Extranjeria': [12],
      Pasaporte: [9],
      'Carne de Refugiado': [10],
      PTP: [9],
    };

    // 5. Funci√≥n para generar el HTML de una fila de la tabla de terapeutas.

    function rowHTML(t) {
      return `
      <td>${t.document_type ?? ''} ${t.document_number ?? ''}</td>
      <td>${t.first_name ?? ''} ${t.last_name_paternal ?? ''} ${t.last_name_maternal ?? ''}</td>
      <td>${t.birth_date ?? ''}</td>
      <td>${t.gender ?? ''}</td>
      <td>${t.email ?? ''}</td>
      <td>${t.phone ?? ''}</td>
      <td>${t.location ?? ''}</td>
      <td>${t.is_active ? 'S√≠' : 'No'}</td>
      <td>${t.profile_picture ? `<img src="${t.profile_picture}" alt="Foto" width="60"/>` : ''}</td>
      <td>
        <button onclick="eliminarTerapeuta('${t.id}',this)">Eliminar</button>
        <button onclick="editarTerapeuta('${t.id}',this)">Editar</button>
        <button onclick="mostrarInfo('${t.id}')">M√°s Info</button>
      </td>
    `;
    }

    // 6. Funci√≥n para construir un FormData desde un formulario, √∫til para enviar archivos (foto de perfil).

    function buildFormData(formEl) {
      const fd = new FormData(formEl);
      if (formEl.is_active) fd.set('is_active', formEl.is_active.checked);

      // üîí Clave: si no se eligi√≥ nueva foto, NO enviar el campo
      const fileInput = formEl.querySelector('input[name="profile_picture"]');
      if (!fileInput?.files?.length) {
        fd.delete('profile_picture');
      }
      return fd;
    }


    // 7. Validaciones de campos num√©ricos y de longitud de documento.
    function addNumericFilter(formEl, fieldNames) {
      fieldNames.forEach((name) => {
        const f = formEl[name];
        if (!f) return;
        f.addEventListener('input', () => {
          f.value = f.value.replace(/\D/g, '');
        });
      });
    }

    // Ajusta el largo m√°ximo del documento seg√∫n el tipo

    function wireDocTypeMaxLength(formEl) {
      if (!formEl?.document_type || !formEl?.document_number) return;
      const apply = () => {
        const t = formEl.document_type.value;
        formEl.document_number.value = (formEl.document_number.value || '').replace(/\D/g, '');
        formEl.document_number.maxLength = DOC_MAX[t] || 20;
      };
      formEl.document_type.addEventListener('change', apply);
      apply();
    }

    // 8. Validaciones comunes para ambos formularios (registro y edici√≥n).

    function validateCommon(formEl) {
      // Requeridos
      const requiredFields = formEl.querySelectorAll('[required]');
      for (let field of requiredFields) {
        if (!String(field.value || '').trim()) {
          Swal.fire({
            icon: 'warning',
            title: 'Campo obligatorio',
            text: 'Por favor completa todos los campos obligatorios.',
          });
          field.focus();
          return false;
        }
      }

      // Documento por tipo
      const docType = formEl.document_type?.value;
      const docNumber = (formEl.document_number?.value || '').trim();
      if (docType && DOC_LENGTHS[docType]) {
        const allowed = DOC_LENGTHS[docType];
        if (!allowed.includes(docNumber.length)) {
          Swal.fire({
            icon: 'error',
            title: 'Documento inv√°lido',
            text: `El n√∫mero de documento debe tener ${allowed.join(' o ')} d√≠gitos para ${docType}.`,
          });
          formEl.document_number.focus();
          return false;
        }
      }

      // Nombres y apellidos
      const nameFields = ['first_name', 'last_name_paternal', 'last_name_maternal'];
      for (let n of nameFields) {
        const v = (formEl[n]?.value || '').trim();
        if (v && !/^[A-Za-z√Å√â√ç√ì√ö√ë√°√©√≠√≥√∫√±0-9\s]+$/.test(v)) {
          Swal.fire({
            icon: 'error',
            title: 'Nombre inv√°lido',
            text: 'Los nombres y apellidos solo deben contener letras y n√∫meros.',
          });
          formEl[n].focus();
          return false;
        }
      }

      // Tel√©fono
      const phone = (formEl.phone?.value || '').trim();
      if (!/^\d{1,15}$/.test(phone)) {
        Swal.fire({
          icon: 'error',
          title: 'Tel√©fono inv√°lido',
          text: 'El tel√©fono debe tener solo n√∫meros, m√°ximo 15 d√≠gitos.',
        });
        formEl.phone.focus();
        return false;
      }

      // Email
      const email = (formEl.email?.value || '').trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        Swal.fire({
          icon: 'error',
          title: 'Correo inv√°lido',
          text: 'Formato de correo inv√°lido.',
        });
        formEl.email.focus();
        return false;
      }
      return true;
    }

    // 9. Funci√≥n throttle para limitar la frecuencia de ejecuci√≥n de la b√∫squeda.

    function throttle(fn, wait = 100) {
      let last = 0, timer;
      return (...args) => {
        const now = Date.now();
        const remaining = wait - (now - last);
        if (remaining <= 0) {
          last = now;
          fn.apply(null, args);
        } else {
          clearTimeout(timer);
          timer = setTimeout(() => {
            last = Date.now();
            fn.apply(null, args);
          }, remaining);
        }
      };
    }

    //   CARGA / RENDER
    // 10. Renderizado de la tabla: muestra loading, error, o los datos de terapeutas.
    function renderLoading() {
      tableBody.innerHTML =
        `<tr><td colspan="10" style="text-align:center;color:#777;">Cargando...</td></tr>`;
    }

    function renderError() {
      tableBody.innerHTML =
        `<tr><td colspan="10" style="text-align:center;color:#c00;">Error al cargar datos</td></tr>`;
      Swal.fire({ icon: 'error', title: 'Error', text: 'Error al cargar datos de terapeutas.' });
    }

    function agregarFila(t, prepend = false) {
      const row = document.createElement('tr');
      row.innerHTML = rowHTML(t);
      if (prepend) tableBody.insertBefore(row, tableBody.firstChild);
      else tableBody.appendChild(row);
    }

    function renderRows(data) {
      tableBody.innerHTML = '';
      if (!data || data.length === 0) {
        tableBody.innerHTML =
          `<tr><td colspan="10" style="text-align:center;color:#777;">Sin resultados</td></tr>`;
        return;
      }
      data.slice().reverse().forEach((t) => agregarFila(t));
    }

    function cargar(query = '') {
      if (currentCancelToken) {
        currentCancelToken.cancel('Operaci√≥n cancelada por nueva b√∫squeda');
      }
      currentCancelToken = axios.CancelToken.source();

      let url = apiUrl + '?active=true';
      if (query) url += `&search=${encodeURIComponent(query)}`;

      renderLoading();

      axios.get(url, { cancelToken: currentCancelToken.token })
        .then((res) => renderRows(res.data))
        .catch((err) => {
          if (!axios.isCancel(err)) {
            console.error(err);
            renderError();
          }
        });
    }

    // 11. CRUD: Eliminar, editar, restaurar terapeutas.

    window.eliminarTerapeuta = function (id, btn) {
      Swal.fire({
        title: '¬øSeguro que deseas eliminar este terapeuta?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠',
        cancelButtonText: 'Cancelar',
      }).then((result) => {
        if (!result.isConfirmed) return;

        axios.delete(apiUrl + id + '/')
          .then(() => {
            const row = btn.closest('tr');
            row?.parentNode?.removeChild(row);
            renderRestoreTable();
            Swal.fire({ icon: 'success', title: 'Eliminado', text: 'Se marc√≥ como inactivo.' });
          })
          .catch((error) => showAxiosError(error, 'No se pudo eliminar.'));
      });
    };

    window.editarTerapeuta = function (id, btn) {
      axios.get(apiUrl + id + '/')
        .then((response) => {
          const terapeuta = response.data;
          openEditModal(terapeuta, btn.closest('tr'));
        })
        .catch((error) => showAxiosError(error, 'No se pudo cargar el terapeuta para edici√≥n.'));
    };

    // Restauraci√≥n (modal)

    document.getElementById('btnRestaurar')?.addEventListener('click', function () {
      renderRestoreTable();
      document.getElementById('restoreModal').style.display = 'flex';
    });

    function renderRestoreTable() {
      const tbody = document.querySelector('#restoreTable tbody');
      tbody.innerHTML =
        `<tr><td colspan="5" style="text-align:center;color:#777;">Cargando...</td></tr>`;

      axios.get(apiUrl + '?active=false')
        .then((response) => {
          const data = response.data;
          tbody.innerHTML = '';
          if (!data || !data.length) {
            tbody.innerHTML =
              `<tr><td colspan="5" style="text-align:center;color:#777;">No hay terapeutas eliminados</td></tr>`;
            return;
          }
          data.forEach((t) => {
            tbody.innerHTML += `
            <tr>
              <td>${t.id}</td>
              <td>${t.first_name ?? ''}</td>
              <td>${t.last_name_paternal ?? ''}</td>
              <td>${t.document_number ?? ''}</td>
              <td>
                <button onclick="restaurarTerapeuta(${t.id})"
                        style="background:#007bff; color:#fff; border:none; border-radius:5px; padding:4px 12px;">
                  Restaurar
                </button>
              </td>
            </tr>
          `;
          });
        })
        .catch((error) => {
          const tbody = document.querySelector('#restoreTable tbody');
          tbody.innerHTML =
            `<tr><td colspan="5" style="text-align:center;color:#c00;">Error al cargar eliminados</td></tr>`;
          showAxiosError(error, 'No se pudieron cargar los terapeutas inactivos.');
        });
    }

    window.restaurarTerapeuta = function (id) {
      axios.post(apiUrl + id + '/restore/')
        .then(() => {
          Swal.fire({ icon: 'success', title: 'Terapeuta restaurado' });
          cargar();
          renderRestoreTable();
        })
        .catch((error) => showAxiosError(error, 'No se pudo restaurar el terapeuta.'));
    };

    window.cerrarRestoreModal = function () {
      document.getElementById('restoreModal').style.display = 'none';
    };

    // Modal Edici√≥n
    // 12. Modal de edici√≥n: abre el formulario con los datos del terapeuta seleccionado.
    function openEditModal(terapeuta, row) {
      editingRow = row;
      editModal.style.display = 'flex';

      // Rellenar campos (sin tocar file inputs)
      for (const key in terapeuta) {
        if (Object.prototype.hasOwnProperty.call(terapeuta, key) && editForm[key] !== undefined) {
          if (editForm[key].type === 'checkbox') {
            editForm[key].checked = !!terapeuta[key];
          } else if (editForm[key].type !== 'file') {
            editForm[key].value = terapeuta[key] ?? '';
          }
        }
      }

      // Miniatura / preview
      let preview = editForm.querySelector('#editProfilePicPreview');
      if (!preview) {
        preview = document.createElement('div');
        preview.id = 'editProfilePicPreview';
        preview.style.marginTop = '10px';
        const afterEl = editForm.querySelector('[name="profile_picture"]');
        if (afterEl) afterEl.insertAdjacentElement('afterend', preview);
      }

      // Poner la imagen actual
      if (terapeuta.profile_picture) {
        preview.innerHTML = `<img src="${terapeuta.profile_picture}" alt="Foto actual" style="max-width:100px; border-radius:6px;">`;
      } else {
        preview.innerHTML = '';
      }

      // **Listener de cambio de foto** (se asegura uno por apertura)
      const fileInput = editForm.querySelector('[name="profile_picture"]');
      if (fileInput) {
        // Si ya hab√≠a un handler anterior, lo quitamos
        if (editForm._picHandler) {
          fileInput.removeEventListener('change', editForm._picHandler);
        }
        // Nuevo handler que actualiza la miniatura cada vez que se elige otra foto
        editForm._picHandler = () => {
          const file = fileInput.files && fileInput.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              preview.innerHTML = `<img src="${e.target.result}" alt="Foto seleccionada" style="max-width:100px; border-radius:6px;">`;
            };
            reader.readAsDataURL(file);
          } else {
            // Si el usuario deselecciona, volvemos a mostrar la original (si hab√≠a)
            preview.innerHTML = terapeuta.profile_picture
              ? `<img src="${terapeuta.profile_picture}" alt="Foto actual" style="max-width:100px; border-radius:6px;">`
              : '';
          }
        };
        fileInput.addEventListener('change', editForm._picHandler);
      }

      wireDocTypeMaxLength(editForm);
    }

    // Al cerrar: limpiamos el listener para no acumularlo y reseteamos el form
    window.closeEditModal = function () {
      const fileInput = editForm.querySelector('[name="profile_picture"]');
      if (fileInput && editForm._picHandler) {
        fileInput.removeEventListener('change', editForm._picHandler);
        editForm._picHandler = null;
      }
      editModal.style.display = 'none';
      editForm.reset();
      editingRow = null;
    };


    // Modal Info
    // 13. Modal de informaci√≥n: muestra detalles ampliados del terapeuta.
    window.mostrarInfo = function (id) {
      axios.get(apiUrl + id + '/')
        .then((response) => {
          const t = response.data;
          const infoContent = document.getElementById('infoContent');
          infoContent.innerHTML = `
          <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
            <div style="background:#43b36a; border-radius:50%; width:70px; height:70px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
              ${t.profile_picture
              ? `<img src="${t.profile_picture}" alt="Foto" style="width:60px;height:60px;border-radius:50%;">`
              : 'üë§'
            }
            </div>
            <div>
              <div style="font-size:1.3em; font-weight:bold;">
                ${t.first_name ?? ''} ${t.last_name_paternal ?? ''} ${t.last_name_maternal ?? ''}
              </div>
              <div style="font-size:1em; color:#b2ffb2;">Documento: ${t.document_number ?? ''}</div>
            </div>
          </div>
          <table style="width:100%; background:#222; border-radius:10px; padding:10px;">
            <tr><td>üìß</td><td>${t.email || 'No registrado'}</td></tr>
            <tr><td>üìû</td><td>${t.phone || 'No registrado'}</td></tr>
            <tr><td><b>Sexo</b></td><td>${t.gender || ''}</td></tr>
            <tr><td><b>Fecha de nacimiento</b></td><td>${t.birth_date || ''}</td></tr>
            <tr><td>üè†</td><td>${t.address || ''}</td></tr>
            <tr><td><b>Departamento</b></td><td>${t.department || ''}</td></tr>
            <tr><td><b>Provincia</b></td><td>${t.province || ''}</td></tr>
            <tr><td><b>Distrito</b></td><td>${t.district || ''}</td></tr>
            <tr><td><b>Referencia personal</b></td><td>${t.personal_reference || ''}</td></tr>
          </table>
        `;
          document.getElementById('infoModal').style.display = 'flex';
        })
        .catch((error) => showAxiosError(error, 'No se pudo cargar la informaci√≥n del terapeuta.'));
    };

    window.cerrarInfoModal = function () {
      document.getElementById('infoModal').style.display = 'none';
      document.getElementById('infoContent').innerHTML = '';
    };

    //   EVENTOS / INIT
    // B√∫squeda con throttle
    // 14. Eventos de b√∫squeda, env√≠o de formularios y carga inicial.
    if (searchInput) {
      searchInput.addEventListener(
        'input',
        throttle(() => {
          cargar(searchInput.value.trim());
        }, 120)
      );
    }

    // Form editar
    editForm.addEventListener('submit', function (e) {
      e.preventDefault();
      if (!validateCommon(editForm)) return;

      const id = editForm.id.value;
      const formData = buildFormData(editForm);

      axios.put(apiUrl + id + '/', formData, {
        headers: { 'Content-Type': 'multipart/form-data' },
      })
        .then((response) => {
          const terapeuta = response.data;
          if (editingRow) editingRow.innerHTML = rowHTML(terapeuta);
          closeEditModal();
          Swal.fire({ icon: 'success', title: 'Actualizado', text: 'El terapeuta ha sido actualizado correctamente.' });
        })
        .catch((error) => showAxiosError(error, 'No se pudo actualizar el terapeuta.'));
    });

    // Form registrar
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (!validateCommon(form)) return;

      const formData = buildFormData(form);

      axios.post(apiUrl, formData, {
        headers: { 'Content-Type': 'multipart/form-data' },
      })
        .then((response) => {
          const nuevo = response.data;
          agregarFila(nuevo, true);
          form.reset();
          Swal.fire({ icon: 'success', title: 'Registrado', text: 'El terapeuta ha sido registrado correctamente.' });
        })
        .catch((error) => showAxiosError(error, 'No se pudo registrar el terapeuta.'));
    });

    // Init
    window.onload = () => {
      cargar(); // inicia con activos
      addNumericFilter(form, ['document_number', 'phone']);
      wireDocTypeMaxLength(form);
      addNumericFilter(editForm, ['document_number', 'phone']);
      wireDocTypeMaxLength(editForm);
    };
  </script>
</body>

</html>